---
title: "03-Data-package-preparation"
output: html_document
---

load the libraries we will be using in this .Rmd file:
```{r}
library(tidyverse) 
library(sf) # sf= simple features! These are spatial objects in R, read here: https://r-spatial.github.io/sf/index.html
library(ggplot2)
```

load car travel time data, the trip level data, and the zones
```{r}
load(file = "data-raw/intermed/ttresults/output_OD_car.Rdata")
load(file = "data/OD_v.RData")
load(file = "data/zn.RData")
```


let's compare *car* travel times to the travel times we actually have in the survey. To do this we first need to add the origin and dest ZN ids to the travel time object. Then we will join them to the CAR trips. 

So first, add ZN ids:
```{r}
zn_t <- zn %>% st_drop_geometry() %>% transmute(FID, 
                                                OZT1259 = ZT1259)

OD_car <- output_OD_car %>% merge(zn_t, by.x=c("fromId"), by.y = c("FID"))

zn_t <- zn %>% st_drop_geometry() %>% transmute(FID,
                                                DZT1259 = ZT1259)

OD_car <- OD_car %>% merge(zn_t, by.x=c("fromId"), by.y = c("FID"))

OD_car <- OD_car %>% select(OZT1259, DZT1259, travel_time)
```

Now merge the calculated travel time to the trip data - ONLY car trips though (so codes 11, 12, 13, 14, 15,16) and ONLY home to work trips.
```{r}
#filter the data... now we only have ~2400 trips left out of the full data set
OD_v_car_hometowork <- OD_v %>% filter(MODO_PRIORITARIO == (10| 11 | 12 | 13 | 14 | 15 | 16)) %>% filter(VORI == "1" & VDES == "2")

OD_v_car_hometowork <- OD_v_car_hometowork  %>% merge(OD_car, by.x=c("VORIZT1259", "VDESZT1259"), by.y = c("OZT1259", "DZT1259"), all.x=TRUE)

```


Let's plot the distribution of r5r car travel times and the survey travel times
```{r}
# make data long
times1 <- OD_v_car_hometowork %>% transmute(tt = TIEMPO_VIAJES, 
                                            L = "survey")
times2 <- OD_v_car_hometowork %>% transmute(tt = travel_time, 
                                            L = "calculated")

ctimes <- rbind(times1, times2)

ggplot(data=ctimes, aes(x=tt, group=L, col=L)) +
    geom_density(adjust=1.5, alpha=.4) 
```
So.. interesting, you can see a few things 

1) there are some longer than 120 car trips (I only calculated up to 120 mins). 
2) the r5r estimation (red line) have many more trips ~30 min while the survey has more at the ~10 min and ~45 min lengths. 